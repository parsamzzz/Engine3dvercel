<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ³Øª Sound Generator</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 20px; background: #fafafa;}
    h1,h2 { color: #333; }
    label { display:block; margin-top:10px; font-weight:bold;}
    input, textarea { width:100%; padding:6px; margin-top:4px; box-sizing:border-box;}
    button { margin-top:15px; padding:8px 16px; cursor:pointer; background:#007bff; color:#fff; border:none; border-radius:4px;}
    button:hover { background:#0056b3;}
    pre { background:#f0f0f0; padding:10px; margin-top:10px; white-space:pre-wrap; border:1px solid #ddd; border-radius:4px;}
    #statusMsg { font-weight:bold; margin-top:10px; color:#006400; }
  </style>
</head>
<body>
  <h1>ğŸ”Š ØªØ³Øª Sound Generator Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±</h1>

  <!-- ÙØ±Ù… Ø³Ø§Ø®Øª ØµØ¯Ø§ -->
  <section>
    <h2>Ø³Ø§Ø®Øª ØµØ¯Ø§</h2>
    <label>ğŸ“ Prompt:
      <textarea id="prompt">ØµØ¯Ø§ÛŒ Ù…ÙˆØ¬ Ø¯Ø±ÛŒØ§ Ù‡Ù†Ú¯Ø§Ù… Ø´Ø¨</textarea>
    </label>

    <label>â³ Ø·ÙˆÙ„ ØµØ¯Ø§ (Ø«Ø§Ù†ÛŒÙ‡):
      <input type="number" id="audio_length" value="10" min="1" max="60" />
    </label>

    <button onclick="createSound()">ğŸ¶ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª ØµØ¯Ø§</button>

    <pre id="createResult">Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª ØµØ¯Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
  </section>

  <!-- ÙˆØ¶Ø¹ÛŒØª -->
  <section>
    <h2>ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø®Øª ØµØ¯Ø§</h2>
    <p id="statusMsg">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...</p>
    <pre id="statusResult">ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
    <audio id="audioPlayer" controls style="display:none; margin-top:10px;"></audio>
  </section>

  <script>
    // ğŸŸ¢ Ø¢Ø¯Ø±Ø³ Ø¨Ú©â€ŒØ§Ù†Ø¯ (ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø¯Ø§Ù…Ù†Ù‡ Ø³Ø±ÙˆØ± Ø®ÙˆØ¯Øª)
    const BASE_API = 'https://engine3dvercel.onrender.com/api/sound';

    let intervalId = null;

    async function createSound() {
      clearInterval(intervalId);
      document.getElementById('statusMsg').textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...';
      document.getElementById('statusResult').textContent = '';
      document.getElementById('audioPlayer').style.display = 'none';

      const data = {
        prompt: document.getElementById('prompt').value,
        audio_length: parseInt(document.getElementById('audio_length').value) || 10,
        webhook_url: '' // Ø¨Ø¯ÙˆÙ† ÙˆØ¨â€ŒÙ‡ÙˆÚ©
      };

      document.getElementById('createResult').textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

      try {
        const res = await fetch(`${BASE_API}/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const json = await res.json();
        document.getElementById('createResult').textContent = JSON.stringify(json, null, 2);

        if (json.task_id) {
          document.getElementById('statusMsg').textContent = `âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯. task_id: ${json.task_id} â€” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...`;
          startAutoCheck(json.task_id);
        } else {
          document.getElementById('statusMsg').textContent = 'âŒ task_id Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        }
      } catch (err) {
        document.getElementById('createResult').textContent = 'âŒ Ø®Ø·Ø§: ' + err.message;
      }
    }

    function startAutoCheck(taskId) {
      intervalId = setInterval(async () => {
        try {
          const res = await fetch(`${BASE_API}/status/${taskId}`);
          const json = await res.json();
          document.getElementById('statusResult').textContent = JSON.stringify(json, null, 2);

          const status = json.conversion?.status || json.status;
          if (status === 'COMPLETED' || status === 'FAILED') {
            clearInterval(intervalId);
            if (status === 'COMPLETED') {
              document.getElementById('statusMsg').textContent = 'ğŸ‰ ØµØ¯Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯!';
              const audioUrl = json.conversion?.conversion_path || json.conversion?.conversion_path_wav;
              if (audioUrl) {
                const player = document.getElementById('audioPlayer');
                player.src = audioUrl;
                player.style.display = 'block';
              }
            } else {
              document.getElementById('statusMsg').textContent = 'âš ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.';
            }
          } else {
            document.getElementById('statusMsg').textContent = `â³ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: ${status || 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...'}`;
          }
        } catch (err) {
          clearInterval(intervalId);
          document.getElementById('statusMsg').textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª.';
        }
      }, 10000); // Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡
    }
  </script>
</body>
</html>
