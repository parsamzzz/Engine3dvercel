<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ğŸµ ØªØ³Øª MusicGPT Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 20px; background: #fafafa;}
    h1,h2 { color: #333; }
    label { display:block; margin-top:10px; font-weight: bold;}
    input, textarea, select { width:100%; padding:6px; margin-top:4px; box-sizing: border-box;}
    button { margin-top:15px; padding:8px 16px; cursor:pointer; background:#007bff; color:#fff; border:none; border-radius:4px;}
    button:hover { background:#0056b3;}
    pre { background:#f0f0f0; padding:10px; margin-top:10px; white-space: pre-wrap; border:1px solid #ddd; border-radius:4px;}
    section { margin-bottom: 40px; }
    #statusMsg { font-weight:bold; color:#006400; margin-top:10px; }
    a.download-link { color:#d6336c; font-weight:bold; }
  </style>
</head>
<body>
  <h1>ğŸµ ØªØ³Øª MusicGPT Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§</h1>

  <!-- Ø³Ø§Ø®Øª Ù…ÙˆØ²ÛŒÚ© -->
  <section>
    <h2>Û±. Ø³Ø§Ø®Øª Ù…ÙˆØ²ÛŒÚ©</h2>

    <label>ğŸ¤ Prompt:
      <textarea id="prompt">ÛŒÚ© Ø¢Ù‡Ù†Ú¯ Ø´Ø§Ø¯ Ø¯Ø±Ø¨Ø§Ø±Ù‡ ØªØ§Ø¨Ø³ØªØ§Ù†</textarea>
    </label>

    <label>ğŸ¼ Music Style:
      <select id="music_style">
        <option value="Pop">Pop - Ù¾Ø§Ù¾</option>
        <option value="Rock">Rock - Ø±Ø§Ú©</option>
        <option value="Hip-Hop">Hip-Hop - Ù‡ÛŒÙ¾â€ŒÙ‡Ø§Ù¾</option>
        <option value="Lo-fi">Lo-fi - Ù„ÙˆÙØ§ÛŒ</option>
        <option value="Jazz">Jazz - Ø¬ÙØ²</option>
        <option value="Classical">Classical - Ú©Ù„Ø§Ø³ÛŒÚ©</option>
        <option value="EDM">EDM - Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©</option>
        <option value="Country">Country - Ú©Ø§Ù†ØªØ±ÛŒ</option>
        <option value="Folk">Folk - ÙÙˆÙ„Ú©</option>
      </select>
    </label>

    <label>ğŸ“ Lyrics (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):
      <textarea id="lyrics"></textarea>
    </label>

    <label>ğŸšï¸ BPM (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):
      <input type="number" id="bpm_request" min="40" max="200" placeholder="Ù…Ø«Ù„Ø§Ù‹ 120" />
    </label>

    <label>ğŸµ Key (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):
      <select id="key_request">
        <option value="">Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ®Ø§Ø¨</option>
        <optgroup label="Ù…Ø§Ú˜ÙˆØ±">
          <option value="C">C</option>
          <option value="C#">C# / Db</option>
          <option value="D">D</option>
          <option value="D#">D# / Eb</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / Gb</option>
          <option value="G">G</option>
          <option value="G#">G# / Ab</option>
          <option value="A">A</option>
          <option value="A#">A# / Bb</option>
          <option value="B">B</option>
        </optgroup>
        <optgroup label="Ù…ÛŒÙ†ÙˆØ±">
          <option value="Cm">Cm</option>
          <option value="C#m">C#m / Dâ™­m</option>
          <option value="Dm">Dm</option>
          <option value="D#m">D#m / Eâ™­m</option>
          <option value="Em">Em</option>
          <option value="Fm">Fm</option>
          <option value="F#m">F#m / Gâ™­m</option>
          <option value="Gm">Gm</option>
          <option value="G#m">G#m / Aâ™­m</option>
          <option value="Am">Am</option>
          <option value="A#m">A#m / Bâ™­m</option>
          <option value="Bm">Bm</option>
        </optgroup>
      </select>
    </label>

    <label>ğŸ™ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ ØµØ¯Ø§:
      <button type="button" onclick="loadVoices()">ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§</button>
      <select id="voiceSelect">
        <option value="">â³ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...</option>
      </select>
    </label>

    <label>
      <input type="checkbox" id="make_instrumental" /> Instrumental Only
    </label>

    <label>
      <input type="checkbox" id="vocal_only" /> Vocal Only
    </label>

    <button onclick="createMusic()">ğŸ¶ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª Ù…ÙˆØ²ÛŒÚ©</button>

    <pre id="createResult">Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª Ù…ÙˆØ²ÛŒÚ© Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
  </section>

  <!-- ÙˆØ¶Ø¹ÛŒØª -->
  <section>
    <h2>Û². Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª</h2>
    <p id="statusMsg">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...</p>
    <pre id="statusResult">ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ²ÛŒÚ© Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
  </section>

  <script>
    const BASE_API = 'https://engine3dvercel.onrender.com/api/music';
    let intervalId = null;

    // ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§
    async function loadVoices() {
      const select = document.getElementById('voiceSelect');
      select.innerHTML = '<option>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</option>';
      try {
        const res = await fetch(`${BASE_API}/voices`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const voices = json.voices || json.data?.voices || [];
        if (voices.length) {
          select.innerHTML = '';
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voice_id;
            opt.textContent = v.voice_name;
            select.appendChild(opt);
          });
          alert('âœ… Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.');
        } else {
          throw new Error('Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§ Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
        }
      } catch (err) {
        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØµØ¯Ø§Ù‡Ø§: ' + err.message);
      }
    }

    // ğŸ¶ Ø³Ø§Ø®Øª Ù…ÙˆØ²ÛŒÚ©
    async function createMusic() {
      clearInterval(intervalId);
      document.getElementById('statusMsg').textContent = 'â³ Ù…Ù†ØªØ¸Ø± Ø§ÛŒØ¬Ø§Ø¯ task_id...';
      document.getElementById('statusResult').textContent = '';

      const data = {
        prompt: document.getElementById('prompt').value,
        music_style: document.getElementById('music_style').value,
        lyrics: document.getElementById('lyrics').value,
        voice_id: document.getElementById('voiceSelect').value,
        bpm_request: parseInt(document.getElementById('bpm_request').value) || 0,
        key_request: document.getElementById('key_request').value,
        make_instrumental: document.getElementById('make_instrumental').checked,
        vocal_only: document.getElementById('vocal_only').checked,
        webhook_url: ''
      };

      document.getElementById('createResult').textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...';

      try {
        const res = await fetch(`${BASE_API}/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        document.getElementById('createResult').textContent = JSON.stringify(json, null, 2);

        const taskId = json.task_id || json.taskId;
        if (taskId) {
          document.getElementById('statusMsg').textContent =
            `âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. task_id: ${taskId} â€” Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±...`;
          startAutoCheck(taskId);
        } else {
          document.getElementById('statusMsg').textContent = 'âŒ task_id Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        }
      } catch (err) {
        document.getElementById('createResult').textContent = 'âŒ Ø®Ø·Ø§: ' + err.message;
      }
    }

    // â³ Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ¶Ø¹ÛŒØª
    function startAutoCheck(taskId) {
      intervalId = setInterval(async () => {
        try {
          const res = await fetch(`${BASE_API}/status/${taskId}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          document.getElementById('statusResult').textContent = JSON.stringify(json, null, 2);

          const status = json.conversion?.status || json.status;
          if (status === 'COMPLETED' || status === 'FAILED') {
            clearInterval(intervalId);

            if (status === 'COMPLETED') {
              const audioUrl = json.conversion?.audio_url || json.audio_url;
              const audioUrl2 = json.conversion?.audio_url_2 || json.audio_url_2;
              let linkHtml = audioUrl
                ? `<a class="download-link" href="${audioUrl}" target="_blank">ğŸ§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„</a>`
                : '';
              if (audioUrl2) {
                linkHtml += ` | <a class="download-link" href="${audioUrl2}" target="_blank">ğŸ§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ø¯ÙˆÙ…</a>`;
              }
              document.getElementById('statusMsg').innerHTML =
                `ğŸ‰ Ù…ÙˆØ²ÛŒÚ© Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯! ${linkHtml}`;
            } else {
              document.getElementById('statusMsg').textContent = 'âš ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.';
            }
          } else {
            document.getElementById('statusMsg').textContent =
              `â³ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: ${status || 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...'}`;
          }
        } catch (err) {
          clearInterval(intervalId);
          document.getElementById('statusMsg').textContent =
            'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª: ' + err.message;
        }
      }, 10000);
    }
  </script>
</body>
</html>
