<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¤ ØªØ³Øª Voice Changer</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 20px; background: #f9f9f9; }
    h1,h2 { color: #333; }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, select { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
    button { margin-top:15px; padding:8px 16px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    pre { background:#f0f0f0; padding:10px; margin-top:10px; white-space:pre-wrap; border:1px solid #ddd; border-radius:4px; }
    audio { margin-top:10px; display:none; }
  </style>
</head>
<body>
  <h1>ğŸ¤ ØªØ³Øª Voice Changer</h1>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§ -->
  <section>
    <h2>Û±. Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ ØµØ¯Ø§</h2>
    <button onclick="loadVoices()">ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§</button>
    <select id="voiceSelect">
      <option value="">â³ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...</option>
    </select>
  </section>

  <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§ Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„ -->
  <section>
    <h2>Û². Ø¢Ù¾Ù„ÙˆØ¯ ÛŒØ§ Ù„ÛŒÙ†Ú© ØµÙˆØªÛŒ</h2>
    <label>ğŸŒ Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):
      <input type="url" id="audioUrl" placeholder="https://example.com/audio.mp3" />
    </label>
    <label>ğŸ“‚ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ:
      <input type="file" id="audioFile" accept="audio/*" />
    </label>

    <label>ğŸšï¸ Pitch (Ø¨ÛŒÙ† -12 ØªØ§ 12):
      <input type="number" id="pitch" value="0" min="-12" max="12" />
    </label>
    <label>
      <input type="checkbox" id="removeBackground" /> Ø­Ø°Ù Ù†ÙˆÛŒØ² Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    </label>

    <button onclick="changeVoice()">ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ¨Ø¯ÛŒÙ„ ØµØ¯Ø§</button>
  </section>

  <!-- Ù†ØªØ§ÛŒØ¬ -->
  <section>
    <h2>Û³. Ù†ØªÛŒØ¬Ù‡</h2>
    <pre id="resultBox">Ø§ÛŒÙ†Ø¬Ø§ Ù†ØªØ§ÛŒØ¬ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
    <audio id="audioPlayer" controls></audio>
  </section>

  <script>
    const BASE_API = 'https://engine3dvercel.onrender.com/api/voice';
    const voiceSelect = document.getElementById('voiceSelect');
    const resultBox = document.getElementById('resultBox');
    const audioPlayer = document.getElementById('audioPlayer');

    // ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§
    async function loadVoices() {
      voiceSelect.innerHTML = '<option>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</option>';
      try {
        const res = await fetch(`${BASE_API}/list`);
        const json = await res.json();
        if (json.success && json.voices) {
          voiceSelect.innerHTML = '';
          json.voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voice_id;
            opt.textContent = v.voice_name;
            voiceSelect.appendChild(opt);
          });
          resultBox.textContent = 'âœ… Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.';
        } else {
          throw new Error('Ù„ÛŒØ³Øª ØµØ¯Ø§Ù‡Ø§ Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
        }
      } catch (err) {
        resultBox.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØµØ¯Ø§Ù‡Ø§: ' + err.message;
      }
    }

    // ğŸš€ ØªØºÛŒÛŒØ± ØµØ¯Ø§
    async function changeVoice() {
      const voiceId = voiceSelect.value;
      const audioUrl = document.getElementById('audioUrl').value.trim();
      const audioFile = document.getElementById('audioFile').files[0];
      const pitch = parseInt(document.getElementById('pitch').value) || 0;
      const removeBackground = document.getElementById('removeBackground').checked ? 1 : 0;

      if (!voiceId) {
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù…Ø¯Ù„ ØµØ¯Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
      }
      if (!audioUrl && !audioFile) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© ÛŒØ§ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.');
        return;
      }

      const formData = new FormData();
      formData.append('voice_id', voiceId);
      formData.append('pitch', pitch);
      formData.append('remove_background', removeBackground);
      if (audioUrl) formData.append('audio_url', audioUrl);
      if (audioFile) formData.append('audio_file', audioFile);

      resultBox.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

      try {
        const res = await fetch(`${BASE_API}/change`, {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        resultBox.textContent = JSON.stringify(json, null, 2);

        if (json.success && json.conversion_id) {
          resultBox.textContent += '\nâ³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...';
          checkStatus(json.conversion_id);
        }
      } catch (err) {
        resultBox.textContent = 'âŒ Ø®Ø·Ø§: ' + err.message;
      }
    }

    // â³ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
    async function checkStatus(conversionId) {
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`${BASE_API}/status/${conversionId}`);
          const json = await res.json();
          resultBox.textContent = JSON.stringify(json, null, 2);

          const status = json.conversion?.status || json.status;
          if (status === 'COMPLETED') {
            clearInterval(interval);
            const audioUrl = json.conversion?.audio_url || json.conversion?.conversion_path;
            if (audioUrl) {
              audioPlayer.src = audioUrl;
              audioPlayer.style.display = 'block';
              resultBox.textContent += '\nâœ… ØµØ¯Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.';
            }
          } else if (status === 'FAILED') {
            clearInterval(interval);
            resultBox.textContent += '\nâŒ ØªØ¨Ø¯ÛŒÙ„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.';
          }
        } catch (err) {
          clearInterval(interval);
          resultBox.textContent += '\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª: ' + err.message;
        }
      }, 8000);
    }
  </script>
</body>
</html>
